"use strict";angular.module("z",["ngRoute","ngAnimate","z.filters","z.services","z.directives","z.controllers"]).config(["$routeProvider",function(t){t.when("/",{templateUrl:"/partials/index.html",controller:"HomeCtrl"}),t.when("/:username",{templateUrl:"/partials/list.html",controller:"ListCtrl"}),t.when("/:username/new",{templateUrl:"/partials/list.html",controller:"ListCtrl"}),t.when("/:username/:postId",{templateUrl:"/partials/read.html",controller:"ReadCtrl"}),t.otherwise({redirectTo:"/"})}]),angular.module("z.controllers",[]).controller("MenuCtrl",["$scope","AuthService","$rootScope","$location",function(t,e,o,n){t.$on("Auth",function(e,o){t.me=o,t.$apply()}),t.me=o.user,t.logout=function(){e.logout()},t.home=function(){n.path("/")},t.isHome=function(){return"/"===n.path()},t.login=e.login,t.posts=function(){n.path("/"+t.me.username)}}]).controller("ReadCtrl",["$scope","AuthService","$routeParams","DBService","$location","$rootScope",function(t,e,o,n,i,r){t.post={body:"",title:""},t.offset=100,t.username=o.username,t.postId=o.postId,n.findPost(t.postId,t.username,function(e){return e.val()?(t.post=e.val(),t.post.date=new Date(t.post.date),console.log("loaded post",t.post),void t.$apply()):console.error("post not found")}),t["delete"]=function(){n.removePost(t.postId,t.username,function(){i.path("/"+t.username),t.$apply()})},t.me=r.user,t.$on("Auth",function(e,o){t.me=o,t.$apply()}),t.edit=function(){t.editing=!0},t.publish=function(){console.log("publishing"),t.waiting=!0,t.post.date=t.post.date.toString(),n.createPost(t.post,r.user.username,function(){t.waiting=!1,console.log("published",t.post.id),t.editing=!1,t.$apply()})}}]).controller("ListCtrl",["$scope","AuthService","$routeParams","DBService","$rootScope","$location",function(t,e,o,n,i,r){t.post={title:localStorage.title||"",body:localStorage.body||""},t.offset=100,t.composing=/^\/.+\/new$/.test(r.path()),t.$watch("post",function(t){localStorage.title=t.title,localStorage.body=t.body},!0),t.username=o.username,t.posts=[],n.posts(t.username,function(e){t.posts=_.sortBy(_.map(_.filter(e.val(),function(t){return t.title}),function(t){return t.date=new Date(t.date),t}),"date").reverse(),console.log("Posts",t.posts),t.$apply()}),t.me=i.user,t.$on("Auth",function(e,o){t.me=o,t.$apply()}),t["new"]=function(){t.post.title="",t.post.body="",t.composing=!0,r.path("/"+i.user.username+"/new"),t.$apply()},t.publish=function(){console.log("publishing"),t.post.date=(new Date).toString(),t.post.id=n.postId(t.post.title),t.post.permalink="/#/"+i.user.username+"/"+t.post.id,t.waiting=!0,n.createPost(t.post,i.user.username,function(){t.waiting=!1,localStorage.title="",localStorage.body="",console.log("published",t.post.id),r.path(i.user.username+"/"+t.post.id),t.$apply()})}}]).controller("HomeCtrl",["$scope","AuthService","DBService","$rootScope","$location",function(t,e,o,n,i){t.login=e.login,t.modal={},t.next=null,t.noop=function(t){t&&t.stopPropagation()},o.posts(function(e){var o=[];_.forEach(e.val(),function(t){_.forEach(_.values(t),function(t){t.date=new Date(t.date),o.push(t)})}),o=_.first(_.sortBy(o,"date").reverse(),10),console.log("posts",o),t.posts=o,t.$apply()}),t.post={title:localStorage.title||"",body:localStorage.body||""},t.$watch("post",function(t){localStorage.title=t.title,localStorage.body=t.body},!0),t.$on("Auth",function(e,o){o&&(t.loginModal=!1,t.next&&t.next())}),t.publish=function(){return n.user?(console.log("publishing"),t.post.date=(new Date).toString(),t.post.id=o.postId(t.post.title),t.post.permalink="/#/"+n.user.username+"/"+t.post.id,t.waiting=!0,o.createPost(t.post,n.user.username,function(){t.waiting=!1,i.path(n.user.username+"/"+t.post.id),localStorage.title="",localStorage.body="",t.$apply()}),void(t.next=null)):(console.log("user not authed"),t.next=t.publish,t.modal.login=!0)},localStorage.once||(localStorage.once=!0,t.post={title:"Blogging at its finest",body:'## Why is Dematerializer different?\nDematerializer aims to be the simplest and most elegant blogging platform for developers, powered by [markdown](https://daringfireball.net/projects/markdown/).\n\n## What can I do with markdown?\n\n### Subtitles\n\n**bolding**\n_italicizing_\n_**or both**_\n\n- lists of \n- things\n\n```js\n// Code embedding\nfunction dematerializer(obj) {\n  "with syntax  highlighting"\n  return void 0\n}\n```\nAnd `backtick` emphasis\n\n> block   \n> quotes\n\n[links](http://zolmeister.com)  \n![images](http://i.imgur.com/79sVqQr.png)\n\nAnd of course you can write paragraphs of text.  \n  \n(newlines require 2 spaces at the end of the line)\n\n\n# YEAH!'})}]),angular.module("z.directives",[]).directive("zPageHeight",["version",function(t){return function(t,e,o){e.css("height",window.innerHeight-o.zPageHeight+"px")}}]).directive("zViewer",function(){return marked.setOptions({highlight:function(t){return hljs.highlightAuto(t).value},sanitize:!0}),function(t,e,o){t.$watch(o.zViewer,function(t){e.html(marked("#["+t.title+"]("+t.permalink+")\n"+t.body))},!0)}}).directive("zScrollSync",["$rootScope",function(t){return function(e,o,n){var i=o[0],r=n.zScrollSync;o.bind("scroll",function(){t.disableScrollListener||t.$broadcast("Scroll",{uid:r,perc:i.scrollTop/i.scrollHeight})}),e.$on("Scroll",function(e,o){if(o.uid!==r){i.scrollTop/i.scrollHeight;t.disableScrollListener=!0,i.scrollTop=o.perc*i.scrollHeight,setTimeout(function(){t.disableScrollListener=!1},50)}})}}]).directive("zViewerText",function(){return function(t,e,o){var n=document.createElement("div");t.$watch(o.zViewerText,function(t){n.innerHTML=marked(t.body),e.html(n.textContent)},!0)}}).directive("spinner",function(){return function(t,e,o){(new Spinner).spin(e[0])}}),angular.module("z.filters",[]).filter("interpolate",["version",function(t){return function(e){return String(e).replace(/\%VERSION\%/gm,t)}}]),angular.module("z.services",[]).value("version","0.1").service("AuthService",["$rootScope","DBService",function(t,e){var o=new FirebaseSimpleLogin(e.db,function(e,o){return e?console.error(e):(console.log("Auth",o),t.user=o,void t.$broadcast("Auth",o))});this.login=function(t){return o.login(t)},this.logout=function(){return o.logout()}}]).service("DBService",function(){this.db=new Firebase("https://glaring-fire-7868.firebaseio.com/"),this.postDB=this.db.child("posts"),this.createPost=function(t,e,o){this.postDB.child(e).child(t.id).set(t,o)},this.findPost=function(t,e,o){this.postDB.child(e).child(t).once("value",o)},this.posts=function(t,e){e||(e=t,t=null),t?this.postDB.child(t).once("value",e):this.postDB.once("value",e)},this.postId=function(t){return encodeURIComponent(t.replace(/\s/g,"-").slice(0,100))},this.removePost=function(t,e,o){console.log("removing post",t,e),this.postDB.child(e).child(t).remove(o)}});